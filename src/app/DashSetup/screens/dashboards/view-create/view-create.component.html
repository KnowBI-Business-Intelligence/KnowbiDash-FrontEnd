<div id="loading-screen" *ngIf="isLoading">
  <div class="spinner"></div>
</div>
<div *ngIf="isDashvoid" class="dash-no-result">
  <span>Dashboard vazio</span>
</div>
<div *ngIf="isDashSelected" class="dash-no-result">
  <span>Selecione ou crie um dashboard</span>
  <button (click)="openStructure()">
    Ir para estrutura
    <fa-icon
      class="icontrend"
      [icon]="icons.arrowTrend"
      [size]="'xl'"
    ></fa-icon>
  </button>
</div>
<div class="container-save-disposition" *ngIf="isDashContent && !isDashvoid">
  <span> Ações </span>
  <div>
    <button (click)="toggleFullScreen()">
      <fa-icon
        class="iconview"
        [icon]="icons.fullScreen"
        [size]="'xl'"
      ></fa-icon
      >Tela cheia
    </button>
    <button (click)="updateCombinedLayout()">
      <fa-icon class="iconview" [icon]="icons.back" [size]="'xl'"></fa-icon
      >Reordenar
    </button>
    <button (click)="saveLayoutUpdated()">
      <p-progressSpinner
        *ngIf="isSaving"
        styleClass="w-1rem h-1rem"
        strokeWidth="8"
        fill="var(--surface-ground)"
        animationDuration=".8s"
      />
      <fa-icon
        *ngIf="!isSaving"
        class="iconview"
        [icon]="icons.save"
        [size]="'xl'"
      ></fa-icon
      >Salvar
    </button>
  </div>
</div>
<div class="container-data" *ngIf="isDashContent && !isDashvoid">
  <span> Dados </span>
  <div>
    <button (click)="openModal()">
      <fa-icon class="iconview" [icon]="icons.filter" [size]="'xl'"></fa-icon
      >Filtros
    </button>
  </div>
</div>
<div class="filter">
  <div class="filter-button">
    <button (click)="openModal()">
      <p>Filtro</p>
      <span class="material-symbols-outlined filter-icon"> filter_alt </span>
    </button>
  </div>
  <div class="filter-container">
    <div class="filter-filters" *ngFor="let filter of filters">
      <div class="filter-filters-data">
        <h3>{{ filter.identifiers }}</h3>
        <span [title]="filter.values">{{ filter.values }}</span>
      </div>
    </div>
  </div>
</div>
<div
  class="main-container contentFS"
  (click)="saveFilterLabel()"
  #fullScreenDiv
  *ngIf="isDashContent && !isDashvoid"
>
  <div class="playground-container">
    <div
      class="grid-container"
      #gridContainer
      [class.full-height]="isFullScreen"
    >
      <ktd-grid
        [cols]="cols"
        [rowHeight]="rowHeight"
        [layout]="layout"
        [gap]="6"
        [compactType]="compactType"
        [preventCollision]="preventCollision"
        [scrollableParent]="gridContainer"
        scrollSpeed="2"
        (dragStarted)="onDragStarted($event)"
        (resizeStarted)="onResizeStarted($event)"
        (dragEnded)="onDragEnded($event)"
        (resizeEnded)="onResizeEnded($event)"
        (layoutUpdated)="onLayoutUpdated($event)"
      >
        <ktd-grid-item
          *ngFor="let item of layout; trackBy: trackById"
          [id]="item.id"
          [transition]="currentTransition"
          [dragStartThreshold]="dragStartThreshold"
          [draggable]="isLoading ? disableDrag : !disableDrag"
          [resizable]="isLoading ? disableDrag : !disableResize"
        >
          <section
            *ngIf="isLoading && item.type == 'card'"
            style="width: 100%; height: 100%; cursor: progress"
            class="menu-container"
          >
            <p-skeleton
              width="100%"
              height="100%"
              styleClass="mb-2"
              borderRadius="3px"
            />
          </section>
          <section
            *ngIf="isLoading && item.type == 'table'"
            style="width: 100%; height: 100%; cursor: progress"
          >
            <p-skeleton
              width="100%"
              height="100%"
              styleClass="mb-2"
              borderRadius="3px"
            />
          </section>
          <section
            *ngIf="isLoading && item.type == 'chart'"
            style="width: 100%; height: 100%; cursor: progress"
          >
            <p-skeleton
              width="100%"
              height="100%"
              styleClass="mb-2"
              borderRadius="3px"
            />
          </section>

          <ng-template ktdGridItemPlaceholder>
            <div class="custom-placeholder-container"></div>
          </ng-template>

          <section
            *ngIf="!isLoading && item.type == 'card'"
            style="width: 100%; height: 100%"
            class="menu-container"
          >
            <button
              [cdkMenuTriggerFor]="menuedit"
              [class.hidden]="isFullScreen"
              class="buttonMenu"
            >
              <fa-icon
                class="iconmenu"
                [icon]="icons.menu"
                [size]="'xl'"
              ></fa-icon>
            </button>
            <div class="card">
              <div class="card-header">
                {{ item.title }}
              </div>
              <div class="card-body">
                <p>{{ item.content }}</p>
              </div>
            </div>
          </section>
          <section
            *ngIf="!isLoading && item.type == 'table'"
            class="table-container mat-elevation-z8 menu-container"
            tabindex="0"
          >
            <button
              [cdkMenuTriggerFor]="menuedit"
              [class.hidden]="isFullScreen"
              class="buttonMenu"
            >
              <fa-icon
                class="iconmenu"
                [icon]="icons.menu"
                [size]="'xl'"
              ></fa-icon>
            </button>
            <h2>{{ item.title }}</h2>
            <div class="table-wrapper">
              <p-table
                matSort
                class="mat-elevation-z8 demo-table"
                selectionMode="single"
                [value]="item.showTableData"
                (matSortChange)="announceSortChange($event)"
                [resizableColumns]="true"
                [scrollable]="true"
                styleClass="p-datatable-gridlines"
                [globalFilterFields]="item.showTableColumns"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th
                      *ngFor="let column of item.showTableColumns"
                      pResizableColumn
                      [pSortableColumn]="column.field"
                      style="min-width: 12rem"
                    >
                      <div class="flex align-items-center">
                        {{ column.header }}
                      </div>
                    </th>
                  </tr>
                </ng-template>

                <ng-template pTemplate="body" let-rowData>
                  <tr
                    #tr
                    pSelectableRow="rowData"
                    pContextMenuRow="rowData"
                    [pSelectableRow]="rowData"
                  >
                    <td *ngFor="let column of item.showTableColumns">
                      {{ rowData[column.field] }}
                    </td>
                  </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="7">Sem registros encontrados</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </section>
          <div
            *ngIf="!isLoading && item.type == 'chart'"
            class="chart-container menu-container"
          >
            <button
              [cdkMenuTriggerFor]="menuedit"
              [class.hidden]="isFullScreen"
              class="buttonMenu"
            >
              <fa-icon
                class="iconmenu"
                [icon]="icons.menu"
                [size]="'xl'"
              ></fa-icon>
            </button>
            <ng-template
              *ngFor="let itemchart of chartGroupsData"
              ktdGridItemPlaceholder
            >
              <div class="custom-placeholder-container"></div>
            </ng-template>
            <section *ngFor="let itemchart of chartGroupsData">
              <highcharts-chart
                *ngIf="item.itemId === itemchart.id"
                [Highcharts]="Highcharts"
                [options]="itemchart.data"
                style="
                  width: 100%;
                  height: 100%;
                  display: block;
                  position: absolute;
                "
                [update]="true"
              ></highcharts-chart>
            </section>
          </div>

          <ng-template #menuedit>
            <div class="edit-menu" cdkMenu>
              <button
                class="edit-button"
                (click)="openModalEdit(item.id, item.itemId, item.type)"
              >
                <fa-icon
                  class="iconmenu"
                  [icon]="icons.edit"
                  [size]="'xl'"
                ></fa-icon>
                <span>Editar</span>
              </button>
              <mat-divider></mat-divider>
              <button
                class="edit-button"
                (click)="openModalExclude(item.id, item.itemId, item.type)"
              >
                <fa-icon
                  class="icontrash"
                  [icon]="icons.delete"
                  [size]="'xl'"
                ></fa-icon>
                <span>Excluir</span>
              </button>
            </div>
          </ng-template>
        </ktd-grid-item>
      </ktd-grid>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Filtros</h2>
        <span class="close" (click)="showFilters()"
          ><span class="material-symbols-outlined close-icon">
            close
          </span></span
        >
      </div>
      <div class="modal-body">
        <div class="modal-fields" *ngFor="let filter of filters; let i = index">
          <div>
            <label
              class="filter-label"
              *ngIf="isEditingIndex !== i"
              (click)="updateFilterLabel(i); $event.stopPropagation()"
              [attr.for]="filter.identifiers"
              >{{ filter.identifiers[0] || "editar" }}</label
            >

            <input
              *ngIf="isEditingIndex === i"
              [(ngModel)]="filter.identifiers[0]"
              (click)="$event.stopPropagation()"
              (blur)="saveFilterLabel()"
            />
          </div>

          <div class="dropdown">
            <ng-container *ngIf="filter.type == 'numeric'">
              <div class="custom-slider" *ngIf="filter.values">
                <ngx-slider
                  [(value)]="filter.values[0]"
                  [(highValue)]="filter.values[1]"
                  [options]="options"
                ></ngx-slider>
              </div>
            </ng-container>

            <ng-container
              *ngIf="filter.type == 'timestamp' && filter.type != 'character'"
            >
              <div class="dropdown-date">
                <mat-date-range-input [rangePicker]="picker">
                  <input
                    matStartDate
                    [placeholder]="filter.values ? filter.values[0] : '-'"
                    [(ngModel)]="filter.values[0]"
                    (dateChange)="updateDate('startDate', filter, $event.value)"
                  />
                  <input
                    matEndDate
                    [placeholder]="
                      filter.values[1] != undefined
                        ? filter.values[1]
                        : filter.values[0]
                    "
                    [(ngModel)]="filter.values[1]"
                    (dateChange)="updateDate('endDate', filter, $event.value)"
                  />
                </mat-date-range-input>
                <mat-datepicker-toggle
                  matIconSuffix
                  [for]="picker"
                ></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
                <mat-date-range-picker #picker></mat-date-range-picker>
              </div>
            </ng-container>

            <ng-container
              *ngIf="filter.type != 'timestamp' && filter.type != 'numeric'"
            >
              <button
                class="dropbtn"
                (click)="showContentFilter(i)"
                *ngIf="filter.values && filter.allfilters"
              >
                {{
                  filter.values.length == filter.allfilters.length ||
                  filter.values.length == 0
                    ? "Todos"
                    : filter.values
                }}
              </button>
            </ng-container>
            <div class="dropdown-content" *ngIf="showContentFilterSwitch[i]">
              <div class="dropdown-cl" *ngFor="let value of filter.allfilters">
                <div>
                  <input
                    class="checkbox"
                    type="checkbox"
                    [checked]="isChecked(filter.values, value)"
                    (change)="onCheckboxChange(filter.column, value)"
                  />
                </div>
                <div>
                  <label>{{ value }}</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="modal-buttons">
          <button class="exclude" (click)="executeFilter()">
            <span>Filtrar</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal-exclude"
  *ngIf="showModal"
  id="modalExclude"
  [style.display]="showModal ? 'flex' : 'none'"
>
  <div class="modal-exclude-content">
    <span class="modal-exclude-close" (click)="closeModalExclude()"
      >&times;</span
    >
    <div>
      <h2>Tem certeza que deseja excluir este item?</h2>
      <p>Esta ação não poderá ser desfeita</p>
      <div class="modal-exclude-buttons">
        <button class="modal-exclude-cancel" (click)="closeModalExclude()">
          Cancelar
        </button>
        <button class="modal-exclude-exclude" (click)="excludeItem()">
          <span>Excluir</span>
        </button>
      </div>
    </div>
  </div>
</div>
