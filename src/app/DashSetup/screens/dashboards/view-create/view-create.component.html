<div class="container-save-disposition">
  <span> Ações </span>
  <div>
    <button (click)="updateCombinedLayout()">
      <fa-icon class="iconview" [icon]="icons.back" [size]="'xl'"></fa-icon
      >Reordenar
    </button>
    <button (click)="saveLayoutUpdated()">
      <fa-icon class="iconview" [icon]="icons.save" [size]="'xl'"></fa-icon
      >Salvar
    </button>
  </div>
</div>
<div class="container-data">
  <span> Dados </span>
  <div>
    <button (click)="openModal()">
      <fa-icon class="iconview" [icon]="icons.filter" [size]="'xl'"></fa-icon
      >Filtros
    </button>
  </div>
</div>
<div class="filter">
  <div class="filter-button">
    <button (click)="openModal()">
      <p>Filtro</p>
      <span class="material-symbols-outlined filter-icon"> filter_alt </span>
    </button>
  </div>
  <div class="filter-container">
    <div class="filter-filters" *ngFor="let filter of filters">
      <div class="filter-filters-data">
        <h3>{{ filter.identifiers }}</h3>
        <span [title]="filter.values">{{ filter.values }}</span>
      </div>
    </div>
  </div>
</div>
<div class="main-container" (click)="saveFilterLabel()">
  <div class="playground-container">
    <div class="grid-container">
      <ktd-grid
        [cols]="cols"
        [rowHeight]="rowHeight"
        [layout]="layout"
        [compactType]="compactType"
        [preventCollision]="preventCollision"
        [scrollableParent]="autoScroll ? document : null"
        scrollSpeed="4"
        (dragStarted)="onDragStarted($event)"
        (resizeStarted)="onResizeStarted($event)"
        (dragEnded)="onDragEnded($event)"
        (resizeEnded)="onResizeEnded($event)"
        (layoutUpdated)="onLayoutUpdated($event)"
      >
        <ktd-grid-item
          *ngFor="let item of layout; trackBy: trackById"
          [id]="item.id"
          [transition]="currentTransition"
          [dragStartThreshold]="dragStartThreshold"
          [draggable]="!disableDrag"
          [resizable]="!disableResize"
        >
          <section
            *ngIf="item.type == 'card'"
            style="width: 100%; height: 100%"
          >
            <div class="card">
              <div class="card-header">
                {{ item.title }}
              </div>
              <div class="card-body">
                <p>{{ item.content }}</p>
              </div>
            </div>
          </section>
          <section
            *ngIf="item.type == 'table'"
            class="table-container mat-elevation-z8"
            tabindex="0"
          >
            <h2>{{ item.title }}</h2>
            <div style="overflow: auto">
              <p-table
                matSort
                class="mat-elevation-z8 demo-table"
                selectionMode="single"
                [value]="item.showTableData"
                (matSortChange)="announceSortChange($event)"
                [resizableColumns]="true"
                [scrollable]="true"
                scrollHeight="100%"
                [tableStyle]="{ 'min-width': '20rem' }"
                scrollHeight="300px"
                styleClass="p-datatable-gridlines"
                [globalFilterFields]="item.showTableColumns"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th
                      *ngFor="let column of item.showTableColumns"
                      pResizableColumn
                      [pSortableColumn]="column.name"
                      style="min-width: 12rem"
                    >
                      <div class="flex align-items-center">
                        {{ column.name }}
                      </div>
                    </th>
                  </tr>
                </ng-template>

                <ng-template pTemplate="body" let-rowData>
                  <tr
                    #tr
                    pSelectableRow="rowData"
                    pContextMenuRow="rowData"
                    [pSelectableRow]="rowData"
                  >
                    <td *ngFor="let column of item.showTableColumns">
                      {{ rowData[column.name] }}
                    </td>
                  </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="7">Sem registros encontrados</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </section>
          <div *ngIf="item.type == 'chart'" class="chart-container">
            <highcharts-chart
              style="width: 100%; height: 100%"
              [Highcharts]="Highcharts"
              [options]="item.data"
            ></highcharts-chart>
          </div>
        </ktd-grid-item>
      </ktd-grid>
    </div>
  </div>
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Filtros</h2>
        <span class="close" (click)="showFilters()"
          ><span class="material-symbols-outlined close-icon">
            close
          </span></span
        >
      </div>
      <div class="modal-body">
        <div class="modal-fields" *ngFor="let filter of filters; let i = index">
          <div>
            <label
              *ngIf="isEditingIndex !== i"
              (click)="updateFilterLabel(i); $event.stopPropagation()"
              [attr.for]="filter.identifiers"
              >{{ filter.identifiers[0] }}</label
            >

            <input
              *ngIf="isEditingIndex === i"
              [(ngModel)]="filter.identifiers[0]"
              (click)="$event.stopPropagation()"
              (blur)="saveFilterLabel()"
            />
          </div>

          <div class="dropdown">
            <button class="dropbtn">
              {{
                selectedFilters[filter.column] ||
                  alfilters(filter.values, filter.allfilters)
              }}
            </button>
            <div class="dropdown-content">
              <div class="dropdown-cl" *ngFor="let value of filter.allfilters">
                <div>
                  <input
                    type="checkbox"
                    [checked]="isChecked(filter.column, value)"
                    (change)="onCheckboxChange(filter.column, value)"
                  />
                </div>
                <div>
                  <label>{{ value }}</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="modal-buttons">
          <button class="exclude" (click)="executeFilter()">
            <span *ngIf="!isLoginLoading">Filtrar</span>
            <span *ngIf="isLoginLoading"
              ><div class="login-spinner"></div
            ></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
